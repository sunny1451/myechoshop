<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Artmart Admin Studio</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    .floating-label-group {
      position: relative;
      margin-bottom: 1.5rem;
    }
    .floating-label {
      position: absolute;
      left: 12px;
      top: 10px;
      color: #6b7280;
      transition: all 0.2s ease;
      pointer-events: none;
    }
    .floating-input:focus + .floating-label,
    .floating-input:not(:placeholder-shown) + .floating-label {
      top: -20px;
      left: 8px;
      font-size: 0.75rem;
      color: #2563eb;
    }
    .dropzone {
      transition: all 0.3s ease;
    }
    .dropzone.dragover {
      background-color: #e5e7eb;
      border-color: #2563eb;
    }
    .upload-btn {
      position: relative;
      overflow: hidden;
    }
    .upload-btn.uploading::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
  </style>
</head>
<body class="bg-gray-100 font-inter">
  <div class="container mx-auto p-4 max-w-5xl">
    <h1 class="text-3xl font-semibold text-gray-800 mb-8 text-center">üõçÔ∏è Artmart Admin Studio</h1>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Form Section -->
      <div class="bg-white p-8 rounded-xl shadow-lg">
        <!-- Image Upload -->
        <div class="floating-label-group mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Upload Image</label>
          <div id="image-dropzone" class="dropzone border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 transition">
            <p class="text-gray-500">Drag & drop or click to upload an image</p>
            <input type="file" id="image-upload" accept="image/*" class="hidden">
          </div>
          <img id="image-preview" class="mt-4 h-48 w-full object-cover rounded-lg hidden" src="" alt="Preview">
          <p id="image-error" class="text-red-500 text-sm mt-2 hidden">Please upload an image</p>
        </div>

        <!-- Form Inputs -->
        <div class="space-y-6">
          <div class="floating-label-group">
            <input type="text" id="product-name" class="floating-input block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3" placeholder=" ">
            <label class="floating-label">Product Name</label>
            <p id="product-name-error" class="text-red-500 text-sm mt-1 hidden">Product name is required</p>
          </div>
          <div class="floating-label-group">
            <input type="text" id="brand" class="floating-input block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3" placeholder=" ">
            <label class="floating-label">Brand (Optional)</label>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div class="floating-label-group">
              <input type="number" id="price" class="floating-input block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3" placeholder=" ">
              <label class="floating-label">Price (‚Çπ)</label>
              <p id="price-error" class="text-red-500 text-sm mt-1 hidden">Price must be a positive number</p>
            </div>
            <div class="floating-label-group">
              <input type="number" id="original-price" class="floating-input block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3" placeholder=" ">
              <label class="floating-label">MRP (‚Çπ)</label>
              <p id="original-price-error" class="text-red-500 text-sm mt-1 hidden">MRP must be a positive number</p>
            </div>
          </div>
          <div class="floating-label-group">
            <input type="text" id="discount" class="floating-input block w-full border-gray-300 rounded-md shadow-sm bg-gray-100 p-3" readonly placeholder=" ">
            <label class="floating-label">Discount (%)</label>
          </div>
          <div class="floating-label-group">
            <select id="category" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3">
              <option value="" disabled selected>Select Category</option>
              <option value="Decor">Decor</option>
              <option value="Dresses">Dresses</option>
              <option value="Shoes">Shoes</option>
              <option value="Animal">Animal</option>
            </select>
            <p id="category-error" class="text-red-500 text-sm mt-1 hidden">Category is required</p>
          </div>
          <div class="floating-label-group">
            <select id="source-location" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3">
              <option value="" disabled selected>Select Source Location</option>
              <option value="Charminar">Charminar</option>
              <option value="KPHB">KPHB</option>
              <option value="Banjara Hills">Banjara Hills</option>
            </select>
            <p id="source-location-error" class="text-red-500 text-sm mt-1 hidden">Source location is required</p>
          </div>
          <div class="floating-label-group">
            <input type="number" id="rating" class="floating-input block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3" placeholder=" " min="0" max="5" step="0.1">
            <label class="floating-label">Rating (0-5, Optional)</label>
            <p id="rating-error" class="text-red-500 text-sm mt-1 hidden">Rating must be between 0 and 5</p>
          </div>
          <div class="grid grid-cols-3 gap-4">
            <div class="flex items-center">
              <input type="checkbox" id="pay-on-delivery" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
              <label class="ml-2 text-sm text-gray-700">Pay on Delivery</label>
            </div>
            <div class="flex items-center">
              <input type="checkbox" id="free-delivery" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
              <label class="ml-2 text-sm text-gray-700">Free Delivery</label>
            </div>
            <div class="flex items-center">
              <input type="checkbox" id="returnable" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
              <label class="ml-2 text-sm text-gray-700">Returnable</label>
            </div>
          </div>
          <div class="floating-label-group">
            <input type="text" id="dimensions" class="floating-input block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3" placeholder=" ">
            <label class="floating-label">Dimensions (e.g., 10.1 x 29.2 x 13.7 cm)</label>
            <p id="dimensions-error" class="text-red-500 text-sm mt-1 hidden">Dimensions format is invalid</p>
          </div>
          <div class="floating-label-group">
            <input type="text" id="special-features" class="floating-input block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3" placeholder=" ">
            <label class="floating-label">Special Features (comma-separated, e.g., Handmade, Abstract)</label>
          </div>
          <div class="floating-label-group">
            <textarea id="description" class="floating-input block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3" rows="5" placeholder=" "></textarea>
            <label class="floating-label">Description</label>
            <p id="description-error" class="text-red-500 text-sm mt-1 hidden">Description is required</p>
          </div>
          <div class="flex space-x-4">
            <button id="upload-btn" class="upload-btn bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition flex items-center">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 0115.9 6 6 6 0 0118 12a4 4 0 01-4 4m-7 0v4m0-4H3m4 0h4"></path></svg>
              Upload Product
            </button>
            <button id="reset-btn" class="bg-gray-300 text-gray-700 px-6 py-3 rounded-md hover:bg-gray-400 transition flex items-center">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
              Reset
            </button>
          </div>
        </div>
      </div>

      <!-- Live Preview Section -->
      <div class="bg-white p-8 rounded-xl shadow-lg">
        <h2 class="text-xl font-medium text-gray-800 mb-6">üßæ Product Preview</h2>
        <div id="preview-card" class="border border-gray-200 rounded-lg p-6">
          <img id="preview-image" class="h-64 w-full object-cover rounded-lg mb-4" src="https://via.placeholder.com/300" alt="Product">
          <h3 id="preview-name" class="text-xl font-semibold text-gray-800">Product Name</h3>
          <p id="preview-brand" class="text-sm text-gray-600">Brand</p>
          <div class="flex items-center mt-2">
            <p id="preview-price" class="text-lg font-bold text-gray-800">‚Çπ0</p>
            <p id="preview-discount" class="text-sm text-green-600 ml-2"></p>
            <p id="preview-original-price" class="text-sm text-gray-500 line-through ml-2">‚Çπ0</p>
          </div>
          <div id="preview-rating" class="flex mt-2"></div>
          <p id="preview-category" class="text-sm text-gray-600 mt-2">Category</p>
          <p id="preview-location" class="text-sm text-gray-600">Location</p>
          <div id="preview-delivery" class="text-sm text-gray-600 mt-2"></div>
          <p id="preview-dimensions" class="text-sm text-gray-600 mt-2">Dimensions</p>
          <div id="preview-features" class="flex flex-wrap gap-2 mt-2"></div>
          <p id="preview-description" class="text-sm text-gray-600 mt-4">Description</p>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAWzOziU-FlMQ7SZLZZTWQMxwFq23tWcwM",
      authDomain: "myechostore.firebaseapp.com",
      projectId: "myechostore",
      storageBucket: "myechostore.firebasestorage.app",
      messagingSenderId: "962362590691",
      appId: "1:962362590691:web:e2c86494039142d0e04cd6",
      measurementId: "G-MC8Q68G4YS"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ImgBB API Key
    const IMGBB_API_KEY = "01400454f4aafb70d1c9beddec5cbbc5";

    // Authentication Check
    onAuthStateChanged(auth, user => {
      if (!user) {
        Swal.fire({
          icon: "error",
          title: "Access Denied",
          text: "Please log in to access the admin panel.",
          confirmButtonColor: "#2563eb"
        }).then(() => {
          window.location.href = "login.html";
        });
      }
    });

    // DOM Elements
    const imageUpload = document.getElementById("image-upload");
    const imagePreview = document.getElementById("image-preview");
    const dropzone = document.getElementById("image-dropzone");
    const productName = document.getElementById("product-name");
    const brand = document.getElementById("brand");
    const price = document.getElementById("price");
    const originalPrice = document.getElementById("original-price");
    const discount = document.getElementById("discount");
    const category = document.getElementById("category");
    const sourceLocation = document.getElementById("source-location");
    const rating = document.getElementById("rating");
    const payOnDelivery = document.getElementById("pay-on-delivery");
    const freeDelivery = document.getElementById("free-delivery");
    const returnable = document.getElementById("returnable");
    const dimensions = document.getElementById("dimensions");
    const specialFeatures = document.getElementById("special-features");
    const description = document.getElementById("description");
    const uploadBtn = document.getElementById("upload-btn");
    const resetBtn = document.getElementById("reset-btn");

    // Error Elements
    const errors = {
      image: document.getElementById("image-error"),
      productName: document.getElementById("product-name-error"),
      price: document.getElementById("price-error"),
      originalPrice: document.getElementById("original-price-error"),
      category: document.getElementById("category-error"),
      sourceLocation: document.getElementById("source-location-error"),
      rating: document.getElementById("rating-error"),
      dimensions: document.getElementById("dimensions-error"),
      description: document.getElementById("description-error")
    };

    // Preview Elements
    const preview = {
      image: document.getElementById("preview-image"),
      name: document.getElementById("preview-name"),
      brand: document.getElementById("preview-brand"),
      price: document.getElementById("preview-price"),
      originalPrice: document.getElementById("preview-original-price"),
      discount: document.getElementById("preview-discount"),
      rating: document.getElementById("preview-rating"),
      category: document.getElementById("preview-category"),
      location: document.getElementById("preview-location"),
      delivery: document.getElementById("preview-delivery"),
      dimensions: document.getElementById("preview-dimensions"),
      features: document.getElementById("preview-features"),
      description: document.getElementById("preview-description")
    };

    // Image Upload and Preview
    dropzone.addEventListener("click", () => imageUpload.click());
    dropzone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropzone.classList.add("dragover");
    });
    dropzone.addEventListener("dragleave", () => dropzone.classList.remove("dragover"));
    dropzone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropzone.classList.remove("dragover");
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith("image/")) {
        imageUpload.files = e.dataTransfer.files;
        previewImage(file);
      } else {
        errors.image.textContent = "Please upload a valid image";
        errors.image.classList.remove("hidden");
      }
    });
    imageUpload.addEventListener("change", () => {
      const file = imageUpload.files[0];
      if (file && file.type.startsWith("image/")) {
        previewImage(file);
        errors.image.classList.add("hidden");
      } else {
        errors.image.textContent = "Please upload a valid image";
        errors.image.classList.remove("hidden");
      }
    });

    function previewImage(file) {
      const reader = new FileReader();
      reader.onload = () => {
        imagePreview.src = reader.result;
        imagePreview.classList.remove("hidden");
        preview.image.src = reader.result;
      };
      reader.readAsDataURL(file);
    }

    // Auto-calculate Discount
    function calculateDiscount() {
      const priceVal = parseFloat(price.value) || 0;
      const originalPriceVal = parseFloat(originalPrice.value) || 0;
      if (priceVal > 0 && originalPriceVal > 0 && priceVal <= originalPriceVal) {
        const discountPercent = ((originalPriceVal - priceVal) / originalPriceVal * 100).toFixed(0);
        discount.value = `${discountPercent}%`;
        preview.discount.textContent = `${discountPercent}% off`;
        preview.price.textContent = `‚Çπ${priceVal.toFixed(2)}`;
        preview.originalPrice.textContent = `‚Çπ${originalPriceVal.toFixed(2)}`;
      } else {
        discount.value = "";
        preview.discount.textContent = "";
        preview.price.textContent = `‚Çπ${priceVal.toFixed(2)}`;
        preview.originalPrice.textContent = originalPriceVal ? `‚Çπ${originalPriceVal.toFixed(2)}` : "";
      }
    }

    price.addEventListener("input", calculateDiscount);
    originalPrice.addEventListener("input", calculateDiscount);

    // Live Preview Updates
    productName.addEventListener("input", () => {
      preview.name.textContent = productName.value || "Product Name";
      errors.productName.classList.add("hidden");
    });
    brand.addEventListener("input", () => {
      preview.brand.textContent = brand.value || "Brand";
    });
    price.addEventListener("input", () => {
      errors.price.classList.add("hidden");
    });
    originalPrice.addEventListener("input", () => {
      errors.originalPrice.classList.add("hidden");
    });
    category.addEventListener("change", () => {
      preview.category.textContent = category.value || "Category";
      errors.category.classList.add("hidden");
    });
    sourceLocation.addEventListener("change", () => {
      preview.location.textContent = sourceLocation.value || "Location";
      errors.sourceLocation.classList.add("hidden");
    });
    rating.addEventListener("input", () => {
      const ratingVal = parseFloat(rating.value) || 0;
      if (ratingVal >= 0 && ratingVal <= 5) {
        preview.rating.innerHTML = "‚òÖ".repeat(Math.floor(ratingVal)) + "‚òÜ".repeat(5 - Math.floor(ratingVal));
        errors.rating.classList.add("hidden");
      } else {
        errors.rating.classList.remove("hidden");
      }
    });
    payOnDelivery.addEventListener("change", updateDeliveryPreview);
    freeDelivery.addEventListener("change", updateDeliveryPreview);
    returnable.addEventListener("change", updateDeliveryPreview);
    dimensions.addEventListener("input", () => {
      preview.dimensions.textContent = dimensions.value || "Dimensions";
      errors.dimensions.classList.add("hidden");
    });
    specialFeatures.addEventListener("input", () => {
      const features = specialFeatures.value.split(",").map(f => f.trim()).filter(f => f);
      preview.features.innerHTML = features.map(f => `<span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded">${f}</span>`).join("");
    });
    description.addEventListener("input", () => {
      preview.description.textContent = description.value || "Description";
      errors.description.classList.add("hidden");
    });

    function updateDeliveryPreview() {
      const deliveryOptions = [];
      if (payOnDelivery.checked) deliveryOptions.push("Pay on Delivery");
      if (freeDelivery.checked) deliveryOptions.push("Free Delivery");
      if (returnable.checked) deliveryOptions.push("10 Days Returnable");
      preview.delivery.textContent = deliveryOptions.length ? deliveryOptions.join(", ") : "No delivery options selected";
    }

    // Form Validation
    function validateForm() {
      let isValid = true;
      if (!imageUpload.files[0]) {
        errors.image.classList.remove("hidden");
        isValid = false;
      }
      if (!productName.value) {
        errors.productName.classList.remove("hidden");
        isValid = false;
      }
      if (!price.value || parseFloat(price.value) <= 0) {
        errors.price.classList.remove("hidden");
        isValid = false;
      }
      if (!originalPrice.value || parseFloat(originalPrice.value) <= 0) {
        errors.originalPrice.classList.remove("hidden");
        isValid = false;
      }
      if (!category.value) {
        errors.category.classList.remove("hidden");
        isValid = false;
      }
      if (!sourceLocation.value) {
        errors.sourceLocation.classList.remove("hidden");
        isValid = false;
      }
      if (rating.value && (parseFloat(rating.value) < 0 || parseFloat(rating.value) > 5)) {
        errors.rating.classList.remove("hidden");
        isValid = false;
      }
      if (dimensions.value && !/^\d+(\.\d)?\s*x\s*\d+(\.\d)?\s*x\s*\d+(\.\d)?\s*cm$/.test(dimensions.value)) {
        errors.dimensions.classList.remove("hidden");
        isValid = false;
      }
      if (!description.value) {
        errors.description.classList.remove("hidden");
        isValid = false;
      }
      return isValid;
    }

    // Upload to ImgBB and Firestore
    uploadBtn.addEventListener("click", async () => {
      if (!validateForm()) return;

      uploadBtn.classList.add("uploading");
      uploadBtn.disabled = true;

      try {
        // Upload image to ImgBB
        const file = imageUpload.files[0];
        const formData = new FormData();
        formData.append("image", file);
        formData.append("key", IMGBB_API_KEY);

        const response = await fetch("https://api.imgbb.com/1/upload", {
          method: "POST",
          body: formData
        });

        const result = await response.json();
        if (!result.success) {
          throw new Error(result.status || "ImgBB upload failed");
        }

        const imageUrl = result.data.url;

        // Prepare product data
        const product = {
          name: productName.value,
          brand: brand.value || "",
          rating: parseFloat(rating.value) || 0,
          ratingsCount: 0,
          price: parseFloat(price.value) || 0,
          originalPrice: parseFloat(originalPrice.value) || 0,
          discount: discount.value || "",
          emi: "",
          offers: {
            cashback: "",
            bank: "",
            partner: ""
          },
          delivery: {
            payOnDelivery: payOnDelivery.checked,
            returnable: returnable.checked ? "10 days" : "",
            freeDelivery: freeDelivery.checked,
            amazonDelivered: false
          },
          specs: {
            theme: category.value === "Animal" ? "Animal" : "",
            brand: brand.value || "",
            color: "",
            material: "",
            occasion: "",
            dimensions: dimensions.value || "",
            specialFeature: specialFeatures.value || "",
            finish: ""
          },
          description: description.value,
          imageUrl: imageUrl,
          sourceLocation: sourceLocation.value,
          createdAt: serverTimestamp()
        };

        // Save to Firestore
        const docRef = await addDoc(collection(db, "products"), product);

        // Show success modal
        Swal.fire({
          icon: "success",
          title: "Product Uploaded!",
          text: `Product added with image at ${imageUrl}`,
          showConfirmButton: true,
          confirmButtonColor: "#2563eb",
          confirmButtonText: "View Product",
          showCancelButton: true,
          cancelButtonText: "Add Another"
        }).then((result) => {
          if (result.isConfirmed) {
            window.location.href = `product.html?id=${docRef.id}`;
          } else {
            resetBtn.click();
          }
        });
      } catch (error) {
        console.error("Error uploading product:", error);
        let errorMessage = "Failed to upload product. Please try again.";
        if (error.message.includes("ImgBB")) {
          errorMessage = "Image upload to ImgBB failed. Check your API key or network.";
        } else if (error.code === "permission-denied") {
          errorMessage = "Permission denied. Please check Firestore security rules.";
        } else if (error.code === "unavailable") {
          errorMessage = "Firestore unavailable. Please check your network or ensure the app is running on a server.";
        }
        Swal.fire({
          icon: "error",
          title: "Upload Failed",
          text: errorMessage,
          confirmButtonColor: "#2563eb"
        });
      } finally {
        uploadBtn.classList.remove("uploading");
        uploadBtn.disabled = false;
      }
    });

    // Reset Form
    resetBtn.addEventListener("click", () => {
      document.querySelectorAll("input, textarea, select").forEach(input => {
        if (input.type === "checkbox") input.checked = false;
        else if (input.tagName === "SELECT") input.value = "";
        else input.value = "";
      });
      imagePreview.classList.add("hidden");
      imagePreview.src = "";
      preview.image.src = "https://via.placeholder.com/300";
      preview.name.textContent = "Product Name";
      preview.brand.textContent = "Brand";
      preview.price.textContent = "‚Çπ0";
      preview.originalPrice.textContent = "‚Çπ0";
      preview.discount.textContent = "";
      preview.rating.innerHTML = "";
      preview.category.textContent = "Category";
      preview.location.textContent = "Location";
      preview.delivery.textContent = "No delivery options selected";
      preview.dimensions.textContent = "Dimensions";
      preview.features.innerHTML = "";
      preview.description.textContent = "Description";
      Object.values(errors).forEach(error => error.classList.add("hidden"));
    });
  </script>
</body>
</html>