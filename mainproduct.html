<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1E40AF">
  <meta name="description" content="Echo Store - View premium Rakhi product details with fast delivery and exclusive deals.">
  <meta name="keywords" content="Rakhi, Raksha Bandhan, online shopping, product details, Echo Store, India">
  <meta name="robots" content="index, follow">
  <title>Echo Store - Rakhi Product Details</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Poppins:wght@600;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <script src="https://unpkg.com/swiper@8.4.7/swiper-bundle.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/swiper@8.4.7/swiper-bundle.min.css">
  <style>
    :root {
      --primary-dark: #1A252F;
      --primary-accent: #1E40AF;
      --accent-hover: #1E3A8A;
      --secondary-accent: #3B82F6;
      --light-bg: #FFFFFF;
      --text-primary: #0F1111;
      --text-secondary: #4B5563;
      --shadow-base: 0 2px 6px rgba(0, 0, 0, 0.1);
      --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.2);
      --gradient-primary: linear-gradient(135deg, #1A252F, #2A3F5F);
      --gradient-accent: linear-gradient(135deg, #1E40AF, #3B82F6);
    }
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--light-bg);
      color: var(--text-primary);
      margin: 0;
      overflow-x: hidden;
      line-height: 1.4;
      font-size: 0.9rem;
    }
    .navbar {
      background: var(--gradient-primary);
      padding: 0.5rem 1rem;
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-base);
      height: 60px;
    }
    .navbar-logo {
      font-family: 'Poppins', sans-serif;
      font-size: 1.2rem;
      font-weight: 800;
      color: #FFF;
      text-decoration: none;
      transition: color 0.3s ease;
    }
    .navbar-logo:hover {
      background: var(--gradient-accent);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .nav-links {
      display: flex;
      gap: 1.5rem;
    }
    .nav-links a {
      color: #FFF;
      font-size: 0.9rem;
      font-weight: 500;
      text-decoration: none;
      position: relative;
      transition: color 0.3s ease;
    }
    .nav-links a::after {
      content: '';
      position: absolute;
      width: 0;
      height: 2px;
      bottom: -4px;
      left: 0;
      background: var(--secondary-accent);
      transition: width 0.3s ease;
    }
    .nav-links a:hover::after {
      width: 100%;
    }
    .nav-links a:hover {
      color: var(--secondary-accent);
    }
    .navbar-btn {
      background: var(--gradient-accent);
      color: #FFF;
      padding: 0.3rem 0.8rem;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 600;
      transition: transform 0.3s ease, background 0.3s ease, box-shadow 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.3rem;
      box-shadow: var(--shadow-base);
    }
    .navbar-btn:hover {
      background: linear-gradient(135deg, #1E3A8A, #3B82F6);
      transform: scale(1.05);
      box-shadow: var(--shadow-hover);
    }
    .search-bar {
      display: flex;
      width: 100%;
      max-width: 250px;
      background-color: #FFF;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: var(--shadow-base);
      height: 35px;
      border: 1px solid var(--primary-accent);
      transition: box-shadow 0.3s ease;
    }
    .search-bar:focus-within {
      box-shadow: 0 0 6px rgba(30, 64, 175, 0.3);
    }
    .search-bar input {
      border: none;
      outline: none;
      flex: 1;
      padding: 0.5rem 0.8rem 0.5rem 1.5rem;
      font-size: 0.8rem;
      color: var(--text-primary);
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="gray" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>') no-repeat 0.5rem center;
    }
    .search-bar button {
      background: var(--gradient-accent);
      color: #FFF;
      border: none;
      padding: 0.5rem 0.8rem;
      cursor: pointer;
      font-size: 0.8rem;
      transition: transform 0.3s ease, background 0.3s ease;
    }
    .search-bar button:hover {
      background: linear-gradient(135deg, #1E3A8A, #3B82F6);
      transform: scale(1.05);
    }
    .product-container {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      max-width: 100%;
    }
    .product-images .swiper {
      max-width: 100%;
      height: 200px;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: var(--shadow-base);
    }
    .product-images .swiper-slide img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 6px;
      transition: transform 0.4s ease;
    }
    .product-images .swiper-slide img:hover {
      transform: scale(1.15);
    }
    .product-images .swiper-slide img.error {
      content: url('https://via.placeholder.com/200x200?text=Image+Not+Found');
    }
    .product-details {
      padding: 0.5rem;
      background: #FFF;
      border-radius: 6px;
      box-shadow: var(--shadow-base);
    }
    .quick-actions {
      padding: 0.5rem;
      background: #FFF;
      border-radius: 6px;
      box-shadow: var(--shadow-base);
      position: static;
    }
    .btn {
      background: var(--gradient-accent);
      color: #FFF;
      padding: 0.5rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: transform 0.3s ease, background 0.3s ease;
      width: 100%;
      margin: 0.25rem 0;
      animation: pulse 2s infinite;
    }
    .btn:hover {
      background: linear-gradient(135deg, #1E3A8A, #3B82F6);
      transform: scale(1.05);
    }
    .btn-buy {
      background: #FF2D55;
      color: #FFF;
    }
    .btn-buy:hover {
      background: #E02447;
      transform: scale(1.05);
    }
    .btn-wishlist.active {
      background: #10B981;
      color: #FFF;
    }
    .btn-wishlist.active:hover {
      background: #059669;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.03); }
      100% { transform: scale(1); }
    }
    .quantity-selector {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0.5rem 0;
    }
    .quantity-selector button {
      background: #E5E7EB;
      border: none;
      padding: 0.4rem 0.8rem;
      cursor: pointer;
      border-radius: 6px;
      font-size: 0.9rem;
      transition: background 0.3s ease;
    }
    .quantity-selector button:hover {
      background: #D1D5DB;
    }
    .variant-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin: 0.5rem 0;
    }
    .variant-selector input[type="radio"] {
      display: none;
    }
    .variant-selector label {
      padding: 0.4rem 0.8rem;
      border: 1px solid #E5E7EB;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s ease;
    }
    .variant-selector input:checked + label {
      background: var(--gradient-accent);
      color: #FFF;
      border-color: transparent;
    }
    .variant-selector label:hover {
      background: #F3F4F6;
    }
    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease;
    }
    .collapsible-content.open {
      max-height: 500px;
    }
    .review-tile {
      background: #F9FAFB;
      padding: 0.75rem;
      border-radius: 6px;
      margin: 0.5rem 0;
      box-shadow: var(--shadow-base);
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.5s ease, transform 0.5s ease;
    }
    .review-tile.visible {
      opacity: 1;
      transform: translateY(0);
    }
    .review-form {
      background: #FFF;
      padding: 0.75rem;
      border-radius: 6px;
      box-shadow: var(--shadow-base);
      margin: 0.5rem 0;
    }
    .star-rating input {
      display: none;
    }
    .star-rating label {
      font-size: 1.2rem;
      color: #D1D5DB;
      cursor: pointer;
      transition: color 0.2s ease;
    }
    .star-rating input:checked ~ label,
    .star-rating label:hover,
    .star-rating label:hover ~ label {
      color: #FBBF24;
    }
    .skeleton {
      background: #E5E7EB;
      animation: skeleton-loading 1s linear infinite alternate;
    }
    @keyframes skeleton-loading {
      0% { background-color: #E5E7EB; }
      100% { background-color: #D1D5DB; }
    }
    .toast {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: #10B981;
      color: #FFF;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      box-shadow: var(--shadow-base);
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.4s ease, transform 0.4s ease;
      z-index: 1000;
    }
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    .error-message {
      background: #FEE2E2;
      color: #B91C1C;
      padding: 0.75rem;
      border-radius: 6px;
      text-align: center;
      margin: 1rem auto;
      max-width: 90%;
    }
    .footer {
      background: var(--primary-dark);
      color: #FFF;
      padding: 1rem;
      text-align: center;
    }
    .footer a {
      color: var(--secondary-accent);
      text-decoration: none;
      margin: 0 0.5rem;
      transition: color 0.3s ease;
    }
    .footer a:hover {
      color: #FFF;
    }
    .login-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }
    .login-modal.show {
      display: flex;
    }
    .login-modal-content {
      background: #FFF;
      padding: 1rem;
      border-radius: 6px;
      box-shadow: var(--shadow-base);
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    @media (max-width: 640px) {
      .navbar {
        flex-direction: column;
        padding: 0.5rem;
        height: auto;
        gap: 0.5rem;
      }
      .nav-links {
        display: none;
      }
      .search-bar {
        width: 100%;
        height: 35px;
      }
      .product-container {
        flex-direction: column;
        padding: 0.5rem;
      }
      .product-images .swiper {
        height: 200px;
      }
      .quick-actions {
        position: static;
      }
      .review-form {
        padding: 0.75rem;
      }
    }
    @media (min-width: 641px) and (max-width: 1024px) {
      .product-container {
        flex-direction: column;
      }
      .quick-actions {
        position: static;
      }
      .product-images .swiper {
        height: 250px;
      }
    }
    @media (min-width: 1025px) {
      .product-container {
        display: grid;
        grid-template-columns: 35% 45% 20%;
      }
      .product-images .swiper {
        height: 450px;
      }
      .quick-actions {
        position: sticky;
        top: 90px;
        align-self: start;
      }
      .nav-links {
        display: flex;
      }
    }
  </style>
</head>
<body class="min-h-screen">
  <!-- Error Message -->
  <div id="error-message" class="error-message hidden">Failed to load product. Please try again later.</div>

  <!-- Header -->
  <nav class="navbar" role="navigation" aria-label="Main navigation">
    <a href="https://sweatshoping.shop/home.html" class="navbar-logo">Sweat shoping</a>
    <div class="nav-links">
      <a href="https://sweatshoping.shop/home.html">Home</a>
      <a href="https://sweatshoping.shop/product.html">Rakhi Products</a>
      <a href="https://sweatshoping.shop/deals.html">Deals</a>
      <a href="https://sweatshoping.shop/contact.html">Support</a>
      <a href="add_product.html" id="add-product-link" class="hidden">Add Product</a>
      <a href="#" id="logout" class="hidden">Logout</a>
    </div>
    <div class="search-bar flex items-center">
      <input id="search-bar" type="text" placeholder="Search Echo Store..." class="text-gray-700 focus:ring-0" aria-label="Search products" autocomplete="off">
      <button aria-label="Search">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
      </button>
      <div id="search-suggestions" class="absolute w-full bg-white shadow-lg rounded-b-md hidden" role="listbox"></div>
    </div>
    <div class="flex items-center space-x-2">
      <button id="auth-status" class="navbar-btn" role="link" tabindex="0">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
        Hello, Sign In
      </button>
      <a href="cart.html" class="navbar-btn" aria-label="View cart">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
        Cart <span id="cart-count" class="ml-1 bg-red-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs">0</span>
      </a>
    </div>
  </nav>

  <!-- Product Section -->
  <section class="product-container" role="region" aria-label="Product details">
    <!-- Left: Images -->
    <div class="product-images">
      <div class="swiper">
        <div class="swiper-wrapper" id="product-images"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-button-next"></div>
        <div class="swiper-pagination"></div>
      </div>
    </div>

    <!-- Center: Details -->
    <div class="product-details">
      <h1 class="text-xl font-semibold" id="product-title">Loading...</h1>
      <p class="text-sm text-yellow-500" id="product-rating">⭐ 0 (0 ratings)</p>
      <p class="text-sm text-gray-500" id="product-popularity">0 bought this month</p>
      <p class="text-lg font-bold" id="product-price">₹0</p>
      <p class="text-sm text-green-600 font-semibold" id="product-stock">Checking stock...</p>
      <p class="text-sm mt-0.5">Brand: <span id="product-brand">Unknown</span></p>
      <div class="delivery-info mt-1">
        <p class="text-sm" id="delivery-info">Checking delivery options...</p>
        <div class="flex items-center gap-1 mt-0.5">
          <span class="text-gray-500">📍</span>
          <span id="product-location" class="text-sm">Unknown</span>
          <button class="text-blue-600 text-xs hover:underline" onclick="updateLocation()">Update</button>
        </div>
      </div>
      <p class="text-sm mt-1">Sold by: Echo Store Retail <span class="text-green-600">🔒 Secure Transaction</span></p>
      <div class="variant-selector" id="variant-selector"></div>
      <div class="mt-2" id="offers"></div>
    </div>

    <!-- Right: Quick Actions -->
    <div class="quick-actions">
      <div class="quantity-selector">
        <button onclick="updateQuantity(-1)">-</button>
        <span id="quantity">1</span>
        <button onclick="updateQuantity(1)">+</button>
      </div>
      <button class="btn" onclick="addToCart()">Add to Cart</button>
      <button class="btn btn-buy" onclick="buyNow()">Buy Now</button>
      <button class="btn btn-wishlist" id="wishlist-btn" onclick="toggleWishlist()">
        <svg id="wishlist-icon" class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
        <span id="wishlist-text">Add to Wishlist</span>
      </button>
      <label class="flex items-center gap-1 mt-1">
        <input type="checkbox" id="gift-option" class="form-checkbox">
        <span class="text-sm">Add Gift Options</span>
      </label>
    </div>
  </section>

  <!-- Product Description -->
  <section class="max-w-1400px mx-auto p-1" role="region" aria-label="Product description">
    <h2 class="text-base font-semibold">Product Description</h2>
    <div id="description-content" class="collapsible-content">
      <p class="text-sm" id="product-description">Loading description...</p>
      <h3 class="text-sm font-semibold mt-1">Technical Specs</h3>
      <p class="text-sm" id="technical-specs">Loading specs...</p>
    </div>
    <button class="text-blue-600 text-sm hover:underline" onclick="toggleDescription()">Show More</button>
  </section>

  <!-- Customer Reviews -->
  <section class="max-w-1400px mx-auto p-1" role="region" aria-label="Customer reviews">
    <div class="review-form">
      <h3 class="text-sm font-semibold">Write a Review</h3>
      <div class="star-rating flex gap-0.5 my-1">
        <input type="radio" name="rating" id="star5" value="5"><label for="star5">★</label>
        <input type="radio" name="rating" id="star4" value="4"><label for="star4">★</label>
        <input type="radio" name="rating" id="star3" value="3"><label for="star3">★</label>
        <input type="radio" name="rating" id="star2" value="2"><label for="star2">★</label>
        <input type="radio" name="rating" id="star1" value="1" checked><label for="star1">★</label>
      </div>
      <textarea id="review-text" class="w-full p-1 border rounded text-sm" placeholder="Your review..." rows="3"></textarea>
      <div id="review-status" class="text-sm mt-1"></div>
      <button class="btn" onclick="submitReview()">Submit Review</button>
    </div>
    <div id="review-tiles">
      <p class="text-sm">No reviews yet.</p>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <div class="text-center">
      <p class="text-base font-poppins">Echo Store</p>
      <p class="text-sm">Your one-stop online store for Rakhi, electronics, fashion, and more.</p>
      <div class="mt-1">
        <a href="about.html">About</a>
        <a href="contact.html">Contact</a>
        <a href="terms.html">Return Policy</a>
        <a href="payment.html">Payment Methods</a>
      </div>
      <div class="mt-1">
        <a href="#" class="inline-block mx-0.5"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3V2z"></path></svg></a>
        <a href="#" class="inline-block mx-0.5"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M23 3a10.9 10.9 0 01-3.14 1.53 4.48 4.48 0 00-7.86 3v1A10.66 10.66 0 013 4s-4 9 5 13a11.64 11.64 0 01-7 2c9 5 20 0 20-11.5a4.5 4.5 0 00-.08-.83A7.72 7.72 0 0023 3z"></path></svg></a>
        <a href="#" class="inline-block mx-0.5"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12c0 4.42 2.87 8.17 6.84 9.49.5.09.68-.22.68-.48v-1.68c-2.78.6-3.37-1.34-3.37-1.34-.45-1.15-1.1-1.46-1.1-1.46-.9-.61.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.89 1.52 2.34 1.08 2.91.83.09-.65.35-1.08.63-1.33-2.22-.25-4.55-1.11-4.55-4.94 0-1.09.39-1.98 1.03-2.68-.1-.25-.45-1.27.1-2.65 0 0 .84-.27 2.75 1.02a9.56 9.56 0 015 0c1.91-1.29 2.75-1.02 2.75-1.02.55 1.38.2 2.4.1 2.65.64.7 1.03 1.59 1.03 2.68 0 3.84-2.34 4.69-4.57 4.94.36.31.68.92.68 1.85v2.74c0 .26.18.58.69.48A9.96 9.96 0 0022 12c0-5.52-4.48-10-10-10z"></path></svg></a>
      </div>
      <p class="text-sm mt-1">© 2025 Sweat shoping. All rights reserved.</p>
    </div>
  </footer>

  <!-- Login Modal -->
  <div id="login-modal" class="login-modal">
    <div class="login-modal-content">
      <h2 class="text-lg font-semibold">Sign In</h2>
      <input type="email" id="login-email" placeholder="Enter your email" class="w-full p-2 mb-2 border rounded" aria-label="Email">
      <input type="password" id="login-password" placeholder="Enter your password" class="w-full p-2 mb-2 border rounded" aria-label="Password">
      <button id="login-submit" class="bg-blue-600 text-white p-2 rounded w-full mb-2" aria-label="Sign In">Sign In</button>
      <button id="login-cancel" class="bg-gray-600 text-white p-2 rounded w-full" aria-label="Cancel">Cancel</button>
      <p id="login-error" class="text-red-600 text-sm mt-2"></p>
      <p class="text-sm mt-2">Not registered? <a href="signup.html" class="text-blue-600">Sign Up</a></p>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast">Action completed successfully!</div>

  <!-- JavaScript -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getFirestore, doc, onSnapshot, collection, query, limit, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import { getAnalytics, logEvent } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAWzOziU-FlMQ7SZLZZTWQMxwFq23tWcwM",
      authDomain: "myechostore.firebaseapp.com",
      projectId: "myechostore",
      storageBucket: "myechostore.firebasestorage.app",
      messagingSenderId: "962362590691",
      appId: "1:962362590691:web:e2c86494039142d0e04cd6",
      measurementId: "G-MC8Q68G4YS"
    };

    // Initialize Firebase
    let app, db, auth, analytics;
    try {
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      analytics = getAnalytics(app);
      console.log("Firebase initialized successfully");
    } catch (error) {
      console.error("Firebase initialization error:", error);
      logAnalyticsError('firebase_init_error', error);
      showToast('Failed to initialize Firebase.', false);
    }

    // Initialize Swiper for Product Images
    const productSwiper = new Swiper('.product-images .swiper', {
      loop: true,
      pagination: { el: '.swiper-pagination', clickable: true },
      navigation: { nextEl: '.swiper-button-prev', prevEl: '.swiper-button-next' },
      spaceBetween: 10,
      effect: 'fade',
      fadeEffect: { crossFade: true }
    });

    // Check Environment
    if (!['http:', 'https:'].includes(window.location.protocol)) {
      document.getElementById('error-message').textContent = 'This page must be served over http or https. Run a local server (e.g., `npx serve` or `python -m http.server 8000`).';
      document.getElementById('error-message').classList.remove('hidden');
      throw new Error('Unsupported protocol. Use http or https.');
    }

    if (!window.localStorage) {
      document.getElementById('error-message').textContent = 'Web storage is not enabled in this browser.';
      document.getElementById('error-message').classList.remove('hidden');
      throw new Error('Web storage is not enabled.');
    }

    // Get Product ID and Category from URL
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');
    const category = urlParams.get('category') || 'Rakhi';

    // Fallback Rakhi Product Data
    const fallbackProduct = {
      id: "1630457891234",
      name: "Designer Rakhi",
      brand: "",
      rating: 0,
      ratingsCount: 0,
      price: 100,
      originalPrice: 150,
      discount: "33%",
      delivery: { payOnDelivery: false, returnable: "", freeDelivery: true, amazonDelivered: false },
      specs: { theme: "", brand: "", color: "Gold", size: "", material: "Beads", occasion: "Raksha Bandhan", specialFeature: "Handmade", finish: "Glossy" },
      description: "A beautiful Rakhi for Raksha Bandhan",
      imageUrls: [
        { name: "image1.jpg", url: "https://via.placeholder.com/200x200?text=Image+Not+Found" }
      ],
      sourceLocation: "KPHB",
      createdAt: "2025-08-02T15:40:00.000Z",
      stock: 10,
      popularity: "50+ bought this month"
    };

    // Log Errors to Firebase Analytics
    const logAnalyticsError = (eventName, error) => {
      logEvent(analytics, eventName, {
        error_message: error.message,
        error_code: error.code || 'unknown',
        timestamp: new Date().toISOString()
      });
    };

    // Show Toast
    const showToast = (message, success = true) => {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.style.background = success ? '#10B981' : '#EF4444';
      toast.classList.add('show');
      gsap.from(toast, { opacity: 0, y: 20, duration: 0.5 });
      setTimeout(() => toast.classList.remove('show'), 3000);
    };

    // Authentication State
    onAuthStateChanged(auth, async (user) => {
      const authButton = document.getElementById('auth-status');
      const addProductLink = document.getElementById('add-product-link');
      const logoutLink = document.getElementById('logout');
      if (user) {
        authButton.innerHTML = `
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
          ${user.displayName || 'User'}
        `;
        authButton.onclick = () => window.location.href = "profile.html";
        addProductLink.classList.remove('hidden');
        logoutLink.classList.remove('hidden');
        logoutLink.onclick = async () => {
          try {
            await signOut(auth);
            showToast("Logged out successfully!");
            window.location.reload();
          } catch (error) {
            console.error("Error logging out:", error);
            showToast(`Error: ${error.message}`, false);
            logAnalyticsError('logout_error', error);
          }
        };
        updateCartCount();
      } else {
        authButton.innerHTML = `
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
          Hello, Sign In
        `;
        authButton.onclick = () => document.getElementById('login-modal').classList.add('show');
        addProductLink.classList.add('hidden');
        logoutLink.classList.add('hidden');
        updateCartCount();
      }
    });

    // Handle Login
    document.getElementById('login-submit').addEventListener('click', async () => {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      const errorElement = document.getElementById('login-error');
      errorElement.textContent = '';

      if (!email || !password) {
        errorElement.textContent = 'Please enter both email and password.';
        return;
      }

      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        showToast(`Welcome, ${userCredential.user.displayName}!`);
        document.getElementById('login-modal').classList.remove('show');
        document.getElementById('login-email').value = '';
        document.getElementById('login-password').value = '';
      } catch (error) {
        console.error("Sign-in error:", error);
        let errorMessage = 'Sign-in failed. Please try again.';
        switch (error.code) {
          case 'auth/wrong-password':
            errorMessage = 'Incorrect password.';
            break;
          case 'auth/user-not-found':
            errorMessage = 'No user found with this email.';
            break;
          case 'auth/invalid-email':
            errorMessage = 'Invalid email format.';
            break;
          default:
            errorMessage = `Sign-in error: ${error.message}`;
        }
        errorElement.textContent = errorMessage;
        logAnalyticsError('sign_in_error', error);
      }
    });

    // Cancel Login
    document.getElementById('login-cancel').addEventListener('click', () => {
      document.getElementById('login-modal').classList.remove('show');
      document.getElementById('login-email').value = '';
      document.getElementById('login-password').value = '';
      document.getElementById('login-error').textContent = '';
    });

    // Load Product Data
    let currentProduct = null;
    const loadProduct = async () => {
      if (!productId) {
        document.getElementById('error-message').textContent = 'No product ID provided.';
        document.getElementById('error-message').classList.remove('hidden');
        renderProduct(fallbackProduct);
        showToast('No product ID provided. Showing sample data.', false);
        return;
      }
      try {
        const rakhiDocRef = doc(db, 'products', 'Rakhi');
        onSnapshot(rakhiDocRef, (doc) => {
          if (doc.exists()) {
            const items = doc.data().items || [];
            const product = items.find(item => item.id === productId);
            if (product) {
              currentProduct = { id: productId, ...product };
              renderProduct(currentProduct);
              logEvent(analytics, 'view_item', {
                item_id: productId,
                item_name: product.name,
                price: product.price
              });
            } else {
              document.getElementById('error-message').textContent = 'Rakhi product not found.';
              document.getElementById('error-message').classList.remove('hidden');
              renderProduct(fallbackProduct);
              showToast('Rakhi product not found. Showing sample data.', false);
              logAnalyticsError('product_not_found', { message: `Product ID ${productId} not found in Rakhi items` });
            }
          } else {
            document.getElementById('error-message').textContent = 'Rakhi category not found.';
            document.getElementById('error-message').classList.remove('hidden');
            renderProduct(fallbackProduct);
            showToast('Rakhi category not found. Showing sample data.', false);
            logAnalyticsError('category_not_found', { message: 'Rakhi document not found' });
          }
        }, (error) => {
          console.error('Error fetching Rakhi product:', error);
          document.getElementById('error-message').textContent = 'Failed to load Rakhi product.';
          document.getElementById('error-message').classList.remove('hidden');
          renderProduct(fallbackProduct);
          showToast('Failed to load Rakhi product.', false);
          logAnalyticsError('product_load_error', error);
        });
      } catch (error) {
        console.error('Error accessing Firestore:', error);
        document.getElementById('error-message').textContent = 'Failed to access Firestore.';
        document.getElementById('error-message').classList.remove('hidden');
        renderProduct(fallbackProduct);
        showToast('Failed to access Firestore.', false);
        logAnalyticsError('firestore_access_error', error);
      }
    };

    // Render Product
    const renderProduct = (product) => {
      document.getElementById('product-title').textContent = product.name || 'Unnamed Rakhi';
      document.getElementById('product-rating').textContent = `⭐ ${product.rating || 0} (${product.ratingsCount || 0} ratings)`;
      document.getElementById('product-popularity').textContent = product.popularity || '0 bought this month';
      document.getElementById('product-price').innerHTML = `₹${product.price || 0} <span class="text-sm text-gray-500 line-through">₹${product.originalPrice || product.price || 0}</span> <span class="text-sm text-green-600">${product.discount || ''}</span>`;
      document.getElementById('product-stock').textContent = product.stock > 0 ? `In Stock: ${product.stock} units` : 'Out of Stock';
      document.getElementById('product-stock').className = `text-sm font-semibold ${product.stock > 0 ? 'text-green-600' : 'text-red-600'}`;
      document.getElementById('product-brand').textContent = product.brand || 'Unknown';
      document.getElementById('product-location').textContent = product.sourceLocation || 'Unknown';
      document.getElementById('delivery-info').innerHTML = `
        ${product.delivery?.freeDelivery ? '<p class="text-sm text-green-600">✅ Free Delivery</p>' : ''}
        ${product.delivery?.payOnDelivery ? '<p class="text-sm text-green-600">💳 Pay on Delivery</p>' : ''}
        ${product.delivery?.returnable ? `<p class="text-sm text-green-600">🔁 ${product.delivery.returnable}</p>` : ''}
      `;
      document.getElementById('product-description').textContent = product.description || 'No description available.';
      document.getElementById('technical-specs').innerHTML = Object.entries(product.specs || {}).map(([key, value]) => `<p><strong>${key.charAt(0).toUpperCase() + key.slice(1)}:</strong> ${value || 'N/A'}</p>`).join('');
      document.getElementById('offers').innerHTML = Object.entries(product.offers || {}).filter(([_, value]) => value).map(([key, value]) => `<p class="text-sm text-green-600">🎁 ${value}</p>`).join('') || '<p class="text-sm">No offers available.</p>';

      // Render Images
      const imageWrapper = document.getElementById('product-images');
      imageWrapper.innerHTML = (product.imageUrls || [{ url: 'https://via.placeholder.com/200x200?text=Image+Not+Found' }]).map(img => `
        <div class="swiper-slide">
          <img src="${img.url}" alt="${product.name || 'Rakhi'}" onerror="this.classList.add('error')">
        </div>
      `).join('');
      productSwiper.update();
      productSwiper.params.loop = (product.imageUrls || []).length >= 2;
      productSwiper.update();

      // Render Variants
      const variantSelector = document.getElementById('variant-selector');
      variantSelector.innerHTML = `
        ${product.specs?.color ? `
          <h3 class="text-sm font-semibold">Color</h3>
          <div>
            <input type="radio" name="color" id="color-${product.specs.color.toLowerCase()}" value="${product.specs.color}" checked>
            <label for="color-${product.specs.color.toLowerCase()}">${product.specs.color}</label>
          </div>
        ` : ''}
        ${product.specs?.size ? `
          <h3 class="text-sm font-semibold mt-1">Size</h3>
          ${product.specs.size.split('/').map(size => `
            <div>
              <input type="radio" name="size" id="size-${size.toLowerCase()}" value="${size}" ${size === product.specs.size.split('/')[0] ? 'checked' : ''}>
              <label for="size-${size.toLowerCase()}">${size}</label>
            </div>
          `).join('')}
        ` : ''}
      `;
    };

    // Quantity Selector
    let quantity = 1;
    window.updateQuantity = (delta) => {
      const stock = document.getElementById('product-stock').textContent.includes('In Stock') ? parseInt(document.getElementById('product-stock').textContent.match(/\d+/)[0]) : 0;
      quantity = Math.max(1, Math.min(quantity + delta, stock));
      document.getElementById('quantity').textContent = quantity;
    };

    // Cart Management
    const updateCartCount = async () => {
      if (!['http:', 'https:'].includes(window.location.protocol)) {
        return;
      }
      const user = auth.currentUser;
      if (user && user.displayName) {
        try {
          const userDoc = await getDoc(doc(db, "users", user.displayName));
          const cart = userDoc.exists() ? userDoc.data().cart || [] : [];
          document.getElementById("cart-count").textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
        } catch (error) {
          console.error("Error updating cart count:", error);
          document.getElementById("cart-count").textContent = "0";
          logAnalyticsError('cart_count_error', error);
        }
      } else {
        const cart = JSON.parse(localStorage.getItem("cart") || "[]");
        document.getElementById("cart-count").textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
      }
    };

    window.addToCart = async () => {
      if (!['http:', 'https:'].includes(window.location.protocol)) {
        showToast("This page must be served over http or https. Run a local server (e.g., `npx serve` or `python -m http.server 8000`).", false);
        return;
      }
      if (!currentProduct) {
        showToast("Product data not loaded.", false);
        return;
      }
      const user = auth.currentUser;
      if (!user || !user.displayName) {
        showToast("Sign-in required to add to cart.", false);
        document.getElementById('login-modal').classList.add('show');
        return;
      }
      if (currentProduct.stock < quantity) {
        showToast("Insufficient stock.", false);
        return;
      }
      try {
        const userDocRef = doc(db, "users", user.displayName);
        const userDoc = await getDoc(userDocRef);
        let cart = userDoc.exists() ? userDoc.data().cart || [] : [];
        const color = document.querySelector('input[name="color"]:checked')?.value || currentProduct.specs?.color || 'N/A';
        const size = document.querySelector('input[name="size"]:checked')?.value || currentProduct.specs?.size?.split('/')[0] || 'N/A';
        const existingItem = cart.find(item => item.id === productId && item.color === color && item.size === size);
        if (existingItem) {
          existingItem.quantity += quantity;
        } else {
          cart.push({
            id: currentProduct.id,
            name: currentProduct.name,
            brand: currentProduct.brand,
            price: currentProduct.price,
            originalPrice: currentProduct.originalPrice,
            discount: currentProduct.discount,
            imageUrls: currentProduct.imageUrls,
            delivery: currentProduct.delivery,
            specs: {
              color: color,
              size: size,
              material: currentProduct.specs?.material,
              occasion: currentProduct.specs?.occasion,
              specialFeature: currentProduct.specs?.specialFeature,
              finish: currentProduct.specs?.finish
            },
            sourceLocation: currentProduct.sourceLocation,
            description: currentProduct.description,
            quantity: quantity,
            addedAt: new Date().toISOString()
          });
        }
        await setDoc(userDocRef, { cart }, { merge: true });
        updateCartCount();
        showToast('Added to cart!');
        logEvent(analytics, 'add_to_cart', { item_id: productId, quantity });
      } catch (error) {
        console.error("Error adding to cart:", error);
        showToast(`Error: ${error.message}`, false);
        logAnalyticsError('add_to_cart_error', error);
      }
    };

    window.buyNow = async () => {
      if (!['http:', 'https:'].includes(window.location.protocol)) {
        showToast("This page must be served over http or https. Run a local server (e.g., `npx serve` or `python -m http.server 8000`).", false);
        return;
      }
      if (!currentProduct) {
        showToast("Product data not loaded.", false);
        return;
      }
      const user = auth.currentUser;
      if (!user || !user.displayName) {
        showToast("Sign-in required to proceed to checkout.", false);
        document.getElementById('login-modal').classList.add('show');
        return;
      }
      if (currentProduct.stock < quantity) {
        showToast("Insufficient stock.", false);
        return;
      }
      try {
        const userDocRef = doc(db, "users", user.displayName);
        const userDoc = await getDoc(userDocRef);
        let cart = userDoc.exists() ? userDoc.data().cart || [] : [];
        const color = document.querySelector('input[name="color"]:checked')?.value || currentProduct.specs?.color || 'N/A';
        const size = document.querySelector('input[name="size"]:checked')?.value || currentProduct.specs?.size?.split('/')[0] || 'N/A';
        const existingItem = cart.find(item => item.id === productId && item.color === color && item.size === size);
        if (!existingItem) {
          cart.push({
            id: currentProduct.id,
            name: currentProduct.name,
            brand: currentProduct.brand,
            price: currentProduct.price,
            originalPrice: currentProduct.originalPrice,
            discount: currentProduct.discount,
            imageUrls: currentProduct.imageUrls,
            delivery: currentProduct.delivery,
            specs: {
              color: color,
              size: size,
              material: currentProduct.specs?.material,
              occasion: currentProduct.specs?.occasion,
              specialFeature: currentProduct.specs?.specialFeature,
              finish: currentProduct.specs?.finish
            },
            sourceLocation: currentProduct.sourceLocation,
            description: currentProduct.description,
            quantity: quantity,
            addedAt: new Date().toISOString()
          });
          await setDoc(userDocRef, { cart }, { merge: true });
        }
        showToast('Proceeding to checkout...');
        setTimeout(() => {
          window.location.href = 'checkout.html';
        }, 1500);
        logEvent(analytics, 'begin_checkout', { item_id: productId, quantity });
      } catch (error) {
        console.error("Error proceeding to checkout:", error);
        showToast(`Error: ${error.message}`, false);
        logAnalyticsError('buy_now_error', error);
      }
    };

    // Wishlist Management
    window.toggleWishlist = () => {
      const wishlistBtn = document.getElementById('wishlist-btn');
      const wishlistText = document.getElementById('wishlist-text');
      const wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
      if (wishlist.includes(productId)) {
        wishlist.splice(wishlist.indexOf(productId), 1);
        wishlistBtn.classList.remove('active');
        wishlistText.textContent = 'Add to Wishlist';
        showToast('Removed from wishlist');
      } else {
        wishlist.push(productId);
        wishlistBtn.classList.add('active');
        wishlistText.textContent = 'Remove from Wishlist';
        showToast('Added to wishlist');
      }
      localStorage.setItem('wishlist', JSON.stringify(wishlist));
      logEvent(analytics, wishlist.includes(productId) ? 'add_to_wishlist' : 'remove_from_wishlist', { item_id: productId });
    };

    // Update Location
    window.updateLocation = async () => {
      if (!['http:', 'https:'].includes(window.location.protocol)) {
        showToast("This page must be served over http or https. Run a local server (e.g., `npx serve` or `python -m http.server 8000`).", false);
        return;
      }
      const user = auth.currentUser;
      if (!user || !user.displayName) {
        showToast("Sign-in required to update location.", false);
        document.getElementById('login-modal').classList.add('show');
        return;
      }
      const newLocation = prompt("Enter new location:");
      if (newLocation) {
        try {
          await setDoc(doc(db, "users", user.displayName), { sourceLocation: newLocation }, { merge: true });
          document.getElementById('product-location').textContent = newLocation;
          showToast("Location updated!");
        } catch (error) {
          console.error("Error updating location:", error);
          showToast(`Error: ${error.message}`, false);
          logAnalyticsError('location_update_error', error);
        }
      }
    };

    // Toggle Description
    window.toggleDescription = () => {
      const content = document.getElementById('description-content');
      const button = document.querySelector('button[onclick="toggleDescription()"]');
      content.classList.toggle('open');
      button.textContent = content.classList.contains('open') ? 'Show Less' : 'Show More';
    };

    // Review Submission
    window.submitReview = async () => {
      if (!['http:', 'https:'].includes(window.location.protocol)) {
        showToast("This page must be served over http or https. Run a local server (e.g., `npx serve` or `python -m http.server 8000`).", false);
        return;
      }
      if (!auth.currentUser) {
        showToast('Please sign in to submit a review.', false);
        document.getElementById('login-modal').classList.add('show');
        return;
      }
      const rating = parseInt(document.querySelector('input[name="rating"]:checked')?.value || 1);
      const text = document.getElementById('review-text').value.trim();
      if (!text) {
        showToast('Please provide a review comment.', false);
        return;
      }
      try {
        const reviewRef = doc(collection(db, 'products', 'Rakhi', 'items', productId, 'reviews'));
        await setDoc(reviewRef, {
          userId: auth.currentUser.uid,
          userName: auth.currentUser.displayName || auth.currentUser.email || 'Anonymous',
          rating: rating,
          text: text,
          timestamp: serverTimestamp()
        });
        showToast('Review submitted successfully!');
        document.getElementById('review-text').value = '';
        document.getElementById('star1').checked = true; // Reset to 1 star
        document.getElementById('review-status').textContent = '';
        logEvent(analytics, 'submit_review', { item_id: productId, rating });
      } catch (error) {
        console.error('Error submitting review:', error);
        let errorMessage = 'Failed to submit review.';
        if (error.code === 'permission-denied') {
          errorMessage = 'You do not have permission to submit a review.';
        } else if (error.code === 'unavailable') {
          errorMessage = 'Firestore is currently unavailable. Try again later.';
        }
        showToast(errorMessage, false);
        logAnalyticsError('review_submit_error', error);
      }
    };

    // Load Reviews
    const loadReviews = () => {
      const reviewTiles = document.getElementById('review-tiles');
      const q = query(collection(db, 'products', 'Rakhi', 'items', productId, 'reviews'), limit(10));
      onSnapshot(q, (snapshot) => {
        if (snapshot.empty) {
          reviewTiles.innerHTML = '<p class="text-sm">No reviews yet.</p>';
        } else {
          reviewTiles.innerHTML = snapshot.docs.map((doc, index) => `
            <div class="review-tile" style="animation-delay: ${index * 0.1}s">
              <p class="text-sm font-semibold">${doc.data().userName}</p>
              <p class="text-sm text-yellow-500">⭐ ${doc.data().rating}</p>
              <p class="text-sm">${doc.data().text}</p>
              <p class="text-xs text-gray-500">${doc.data().timestamp ? new Date(doc.data().timestamp.toDate()).toLocaleDateString() : 'Just now'}</p>
            </div>
          `).join('');
          gsap.from('.review-tile', { opacity: 0, y: 20, duration: 0.5, stagger: 0.1 });
        }
      }, (error) => {
        console.error('Error fetching reviews:', error);
        showToast('Failed to load reviews.', false);
        reviewTiles.innerHTML = '<p class="text-sm text-red-600">Failed to load reviews.</p>';
        logAnalyticsError('review_load_error', error);
      });
    };

    // Search Suggestions
    const updateSearchSuggestions = async () => {
      const searchBar = document.getElementById('search-bar');
      const suggestions = document.getElementById('search-suggestions');
      searchBar.addEventListener('input', async () => {
        const queryText = searchBar.value.toLowerCase();
        if (queryText.length < 2) {
          suggestions.classList.add('hidden');
          return;
        }
        try {
          const rakhiDocRef = doc(db, 'products', 'Rakhi');
          const docSnap = await getDoc(rakhiDocRef);
          const results = docSnap.exists()
            ? (docSnap.data().items || []).filter(p => p.name.toLowerCase().includes(queryText))
            : [];
          suggestions.innerHTML = results.map(p => `
            <a href="mainproduct.html?id=${p.id}&category=Rakhi" class="block p-1 hover:bg-gray-100 text-sm">${p.name}</a>
          `).join('');
          suggestions.classList.toggle('hidden', results.length === 0);
        } catch (error) {
          console.error('Search error:', error);
          suggestions.classList.add('hidden');
          logAnalyticsError('search_error', error);
        }
      });
    };

    // Initialize
    loadProduct();
    loadReviews();
    updateSearchSuggestions();
    updateCartCount();
    logEvent(analytics, 'page_view', { page_title: document.title, page_location: window.location.href });
  </script>
</body>
</html>

